// DataRoom - Prisma Schema
// Restructured: DataRoom is the main container (no separate Team entity)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// User Management & Authentication
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String? // For email/password authentication
  isActive      Boolean   @default(true) // For user activation/deactivation

  // Password reset
  passwordResetToken  String?   @unique
  passwordResetExpiry DateTime?

  // Two-factor authentication
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  // VDR-specific fields
  status       String   @default("ACTIVE") // PENDING_INVITE, ACTIVE, DEACTIVATED, EXPIRED
  accessType   String   @default("UNLIMITED") // UNLIMITED, LIMITED
  accessStartAt DateTime?
  accessEndAt   DateTime?
  allowedIps    Json?    // Array of allowed IP addresses/CIDR ranges

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  accounts          Account[]
  sessions          Session[]
  documents         Document[]
  documentVersions  DocumentVersion[] @relation("DocumentVersions")
  folders           Folder[]
  links             Link[]
  views             View[]
  notifications     Notification[]
  notificationPreference NotificationPreference?
  auditLogs         AuditLog[]
  recoveryCodes     RecoveryCode[]
  questionsAsked    Question[]        @relation("QuestionsAsked")
  questionsAssigned Question[]        @relation("QuestionsAssigned")
  answersProvided   Answer[]          @relation("AnswersProvided")
  commentsCreated   Comment[]         @relation("CommentsCreated")
  commentMentions   CommentMention[]  @relation("CommentMentions")
  
  // VDR Relations
  groupMemberships  GroupMember[]
  invitationsCreated UserInvitation[] @relation("InvitationsCreated")
  documentUserPermissions DocumentUserPermission[]
  folderUserPermissions   FolderUserPermission[]

  @@index([isActive])
  @@index([status])
  @@map("users")
}

model RecoveryCode {
  id        String   @id @default(cuid())
  code      String   @unique
  used      Boolean  @default(false)
  usedAt    DateTime?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("recovery_codes")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  // Session metadata for security tracking
  ipAddress    String?
  userAgent    String?  @db.Text
  device       String?
  browser      String?
  os           String?
  location     String?
  
  createdAt    DateTime @default(now())
  lastActivity DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// Virtual Data Room (Main Container)
// ============================================

model DataRoom {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  logo        String?
  isPublic    Boolean  @default(false)
  plan        String   @default("free") // free, pro, business, enterprise
  
  // Branding
  brandColor       String?
  accentColor      String?
  customDomain     String?
  watermarkEnabled Boolean @default(true)
  watermarkText    String?
  watermarkOpacity Float?  @default(0.3)
  
  // File Upload Security
  maxFileSize      Int     @default(104857600) // 100MB
  allowedFileTypes Json?
  
  // VDR-specific settings
  qnaEnabled                     Boolean   @default(false)
  dueDiligenceChecklistEnabled   Boolean   @default(false)
  archivedAt                     DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  documents    Document[]
  folders      Folder[]
  questions    Question[]
  qaCategories QACategory[]
  auditLogs    AuditLog[]
  tags         Tag[]
  groups       Group[]
  userInvitations           UserInvitation[]
  dueDiligenceChecklists    DueDiligenceChecklist[]

  @@index([archivedAt])
  @@map("data_rooms")
}

// ============================================
// Document Management
// ============================================

model Document {
  id          String   @id @default(cuid())
  name        String
  description String?
  file        String
  fileType    String
  fileSize    Int
  versions    Int      @default(1)
  dataRoomId  String
  ownerId     String
  folderId    String?
  
  // File Security
  scanStatus String?  @default("pending")
  scanResult Json?
  
  // Soft delete
  deletedAt   DateTime?
  deletedById String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  dataRoom         DataRoom          @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  owner            User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  folder           Folder?           @relation(fields: [folderId], references: [id], onDelete: SetNull)
  links            Link[]
  views            View[]
  versions_history DocumentVersion[]
  metadata         DocumentMetadata[]
  tags             DocumentTag[]
  comments         Comment[]
  groupPermissions DocumentGroupPermission[]
  userPermissions  DocumentUserPermission[]

  @@index([dataRoomId])
  @@index([ownerId])
  @@index([folderId])
  @@index([scanStatus])
  @@index([deletedAt])
  @@map("documents")
}

model DocumentVersion {
  id            String   @id @default(cuid())
  documentId    String
  versionNumber Int
  file          String
  fileSize      Int
  fileName      String?
  fileType      String?
  comment       String?  @db.Text
  metadata      Json?
  createdById   String
  createdAt     DateTime @default(now())

  document  Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  createdBy User     @relation("DocumentVersions", fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([documentId, versionNumber])
  @@index([documentId])
  @@index([createdById])
  @@map("document_versions")
}

// ============================================
// Folder Structure
// ============================================

model Folder {
  id         String   @id @default(cuid())
  name       String
  dataRoomId String
  ownerId    String
  parentId   String?
  path       String
  
  deletedAt   DateTime?
  deletedById String?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  dataRoom  DataRoom   @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  owner     User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  parent    Folder?    @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  Folder[]   @relation("FolderHierarchy")
  documents Document[]
  groupPermissions FolderGroupPermission[]
  userPermissions  FolderUserPermission[]

  @@index([dataRoomId])
  @@index([parentId])
  @@index([deletedAt])
  @@map("folders")
}

// ============================================
// Link Sharing & Access Control
// ============================================

model Link {
  id          String  @id @default(cuid())
  slug        String  @unique
  documentId  String
  name        String?
  description String?
  createdBy   String
  isActive    Boolean @default(true)

  password           String?
  expiresAt          DateTime?
  allowDownload      Boolean   @default(true)
  allowNotification  Boolean   @default(true)
  emailProtected     Boolean   @default(false)
  emailAuthenticated Boolean   @default(false)
  domainSlug         String?
  maxViews           Int?
  viewCount          Int   @default(0)
  allowedDomains     Json?
  enableTracking     Boolean @default(true)
  enableFeedback     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  document      Document           @relation(fields: [documentId], references: [id], onDelete: Cascade)
  creator       User               @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  views         View[]
  allowedEmails LinkAllowedEmail[]

  @@index([documentId])
  @@index([slug])
  @@index([viewCount])
  @@map("links")
}

model LinkAllowedEmail {
  id        String   @id @default(cuid())
  linkId    String
  email     String
  createdAt DateTime @default(now())

  link Link @relation(fields: [linkId], references: [id], onDelete: Cascade)

  @@unique([linkId, email])
  @@map("link_allowed_emails")
}

// ============================================
// View Tracking & Analytics
// ============================================

model View {
  id          String  @id @default(cuid())
  linkId      String
  documentId  String
  viewerEmail String?
  viewerName  String?
  verified    Boolean @default(false)

  ipAddress String?
  userAgent String?
  country   String?
  city      String?

  viewedAt       DateTime  @default(now())
  duration       Int?
  completionRate Float?
  downloadedAt   DateTime?

  link     Link     @relation(fields: [linkId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  viewer   User?    @relation(fields: [viewerEmail], references: [email])

  @@index([linkId])
  @@index([documentId])
  @@index([viewedAt])
  @@map("views")
}

// ============================================
// Audit Trail & Activity Log
// ============================================

model AuditLog {
  id           String   @id @default(cuid())
  dataRoomId   String?
  userId       String?
  action       String
  resourceType String
  resourceId   String?
  metadata     Json?
  ipAddress    String?
  userAgent    String?
  hash         String?
  previousHash String?
  createdAt    DateTime @default(now())

  dataRoom DataRoom? @relation(fields: [dataRoomId], references: [id], onDelete: SetNull)
  user     User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([dataRoomId])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@index([action])
  @@map("audit_logs")
}

// ============================================
// Q&A System
// ============================================

model Question {
  id           String   @id @default(cuid())
  dataRoomId   String
  categoryId   String?
  questionText String   @db.Text
  status       String   @default("pending")
  priority     String   @default("normal")
  askedById    String
  assignedToId String?
  bidderGroup  String?
  isPrivate    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  dataRoom   DataRoom    @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  category   QACategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  askedBy    User        @relation("QuestionsAsked", fields: [askedById], references: [id], onDelete: Cascade)
  assignedTo User?       @relation("QuestionsAssigned", fields: [assignedToId], references: [id], onDelete: SetNull)
  answers    Answer[]

  @@index([dataRoomId])
  @@index([status])
  @@index([bidderGroup])
  @@index([askedById])
  @@index([assignedToId])
  @@map("questions")
}

model Answer {
  id         String   @id @default(cuid())
  questionId String
  answerText String   @db.Text
  answeredBy String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user     User     @relation("AnswersProvided", fields: [answeredBy], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@index([answeredBy])
  @@map("answers")
}

model QACategory {
  id          String   @id @default(cuid())
  dataRoomId  String
  name        String
  description String?
  color       String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  dataRoom  DataRoom   @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  questions Question[]

  @@unique([dataRoomId, name])
  @@index([dataRoomId])
  @@map("qa_categories")
}

// ============================================
// Document Metadata & Tags
// ============================================

model DocumentMetadata {
  id         String   @id @default(cuid())
  documentId String
  key        String
  value      String   @db.Text
  type       String   @default("text")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, key])
  @@index([documentId])
  @@index([key])
  @@map("document_metadata")
}

model Tag {
  id         String   @id @default(cuid())
  dataRoomId String
  name       String
  color      String?
  createdAt  DateTime @default(now())

  dataRoom  DataRoom     @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  documents DocumentTag[]

  @@unique([dataRoomId, name])
  @@index([dataRoomId])
  @@map("tags")
}

model DocumentTag {
  id         String   @id @default(cuid())
  documentId String
  tagId      String
  createdAt  DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([documentId, tagId])
  @@index([documentId])
  @@index([tagId])
  @@map("document_tags")
}

// ============================================
// Document Comments & Collaboration
// ============================================

model Comment {
  id         String    @id @default(cuid())
  documentId String
  userId     String
  content    String    @db.Text
  parentId   String?
  isPrivate  Boolean   @default(false)
  resolved   Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  document Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User             @relation("CommentsCreated", fields: [userId], references: [id], onDelete: Cascade)
  parent   Comment?         @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[]        @relation("CommentThread")
  mentions CommentMention[]

  @@index([documentId])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
}

model CommentMention {
  id        String    @id @default(cuid())
  commentId String
  userId    String
  read      Boolean   @default(false)
  createdAt DateTime  @default(now())

  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User    @relation("CommentMentions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([userId, read])
  @@map("comment_mentions")
}

// ============================================
// Notifications
// ============================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  metadata  Json?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreference {
  id      String @id @default(cuid())
  userId  String @unique
  
  emailEnabled          Boolean @default(true)
  emailLinkViewed       Boolean @default(true)
  emailDocumentShared   Boolean @default(true)
  emailGroupInvitation  Boolean @default(true)
  emailCommentMention   Boolean @default(true)
  emailQAActivity       Boolean @default(true)
  inAppEnabled          Boolean @default(true)
  desktopEnabled        Boolean @default(false)
  digestEnabled         Boolean @default(false)
  digestFrequency       String  @default("daily")
  digestTime            String  @default("09:00")
  soundEnabled          Boolean @default(true)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("notification_preferences")
}

// ============================================
// VDR: Groups & Group Members
// ============================================

enum GroupType {
  ADMINISTRATOR
  USER
  CUSTOM
}

model Group {
  id          String    @id @default(cuid())
  dataRoomId  String
  name        String
  description String?
  type        GroupType @default(USER)
  
  canViewDueDiligenceChecklist Boolean @default(false)
  canManageDocumentPermissions Boolean @default(false)
  canViewGroupUsers           Boolean @default(false)
  canManageUsers              Boolean @default(false)
  canViewGroupActivity        Boolean @default(false)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  dataRoom             DataRoom                 @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  members              GroupMember[]
  documentPermissions  DocumentGroupPermission[]
  folderPermissions    FolderGroupPermission[]
  
  @@index([dataRoomId])
  @@index([type])
  @@map("groups")
}

model GroupMember {
  id        String   @id @default(cuid())
  groupId   String
  userId    String
  role      String   @default("member") // owner, admin, member, viewer
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("group_members")
}

// ============================================
// VDR: User Invitations
// ============================================

model UserInvitation {
  id         String   @id @default(cuid())
  email      String
  dataRoomId String
  groupIds   Json
  role       String   @default("member")
  token      String   @unique
  expiresAt  DateTime
  createdById String
  createdAt  DateTime @default(now())
  
  dataRoom  DataRoom @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  createdBy User     @relation("InvitationsCreated", fields: [createdById], references: [id], onDelete: Cascade)
  
  @@unique([dataRoomId, email])
  @@index([token])
  @@index([email])
  @@index([dataRoomId])
  @@map("user_invitations")
}

// ============================================
// VDR: Document & Folder Permissions
// ============================================

model DocumentGroupPermission {
  id                   String  @id @default(cuid())
  documentId           String
  groupId              String
  canFence             Boolean @default(false)
  canView              Boolean @default(false)
  canDownloadEncrypted Boolean @default(false)
  canDownloadPdf       Boolean @default(false)
  canDownloadOriginal  Boolean @default(false)
  canUpload            Boolean @default(false)
  canManage            Boolean @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@unique([documentId, groupId])
  @@index([documentId])
  @@index([groupId])
  @@map("document_group_permissions")
}

model DocumentUserPermission {
  id                   String  @id @default(cuid())
  documentId           String
  userId               String
  canFence             Boolean @default(false)
  canView              Boolean @default(false)
  canDownloadEncrypted Boolean @default(false)
  canDownloadPdf       Boolean @default(false)
  canDownloadOriginal  Boolean @default(false)
  canUpload            Boolean @default(false)
  canManage            Boolean @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([documentId, userId])
  @@index([documentId])
  @@index([userId])
  @@map("document_user_permissions")
}

model FolderGroupPermission {
  id                   String  @id @default(cuid())
  folderId             String
  groupId              String
  canFence             Boolean @default(false)
  canView              Boolean @default(false)
  canDownloadEncrypted Boolean @default(false)
  canDownloadPdf       Boolean @default(false)
  canDownloadOriginal  Boolean @default(false)
  canUpload            Boolean @default(false)
  canManage            Boolean @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  folder Folder @relation(fields: [folderId], references: [id], onDelete: Cascade)
  group  Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@unique([folderId, groupId])
  @@index([folderId])
  @@index([groupId])
  @@map("folder_group_permissions")
}

model FolderUserPermission {
  id                   String  @id @default(cuid())
  folderId             String
  userId               String
  canFence             Boolean @default(false)
  canView              Boolean @default(false)
  canDownloadEncrypted Boolean @default(false)
  canDownloadPdf       Boolean @default(false)
  canDownloadOriginal  Boolean @default(false)
  canUpload            Boolean @default(false)
  canManage            Boolean @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  folder Folder @relation(fields: [folderId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([folderId, userId])
  @@index([folderId])
  @@index([userId])
  @@map("folder_user_permissions")
}

// ============================================
// VDR: Due Diligence Checklists
// ============================================

model DueDiligenceChecklist {
  id          String   @id @default(cuid())
  dataRoomId  String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  dataRoom DataRoom              @relation(fields: [dataRoomId], references: [id], onDelete: Cascade)
  items    DueDiligenceItem[]
  
  @@index([dataRoomId])
  @@map("due_diligence_checklists")
}

model DueDiligenceItem {
  id          String   @id @default(cuid())
  checklistId String
  title       String
  description String?  @db.Text
  completed   Boolean  @default(false)
  completedBy String?
  completedAt DateTime?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  checklist DueDiligenceChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  
  @@index([checklistId])
  @@map("due_diligence_items")
}

// ============================================
// VDR: Email Templates
// ============================================

model EmailTemplate {
  id          String   @id @default(cuid())
  name        String   @unique // "invitation", "password_reset", etc.
  subject     String
  htmlContent String   @db.Text
  textContent String?  @db.Text
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([name])
  @@map("email_templates")
}
